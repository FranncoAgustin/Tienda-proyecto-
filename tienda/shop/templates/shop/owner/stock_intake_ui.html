{% extends "base.html" %}
{% block title %}Ingresar stock{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 mb-0">Ingresar stock</h1>
    <div class="btn-group">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'owner_dashboard' %}">‚Üê Volver</a>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'owner_bitacora' %}">üìú Bit√°cora</a>
    </div>
  </div>

  <!-- Alta r√°pida de producto -->
  <div class="card mb-3">
    <div class="card-header">
      <button class="btn btn-link p-0" data-bs-toggle="collapse" data-bs-target="#nuevoProducto" aria-expanded="false">
        ‚ûï Nuevo producto (alta r√°pida)
      </button>
    </div>
    <div id="nuevoProducto" class="collapse">
      <div class="card-body">
        <form id="newProductForm" class="row g-3">
          {% csrf_token %}
          <div class="col-md-3">
            <label class="form-label">SKU *</label>
            <input id="np_sku" type="text" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">Nombre p√∫blico</label>
            <input id="np_public_name" type="text" class="form-control" placeholder="Si lo dej√°s vac√≠o, usa el SKU">
          </div>
          <div class="col-md-2">
            <label class="form-label">Precio base</label>
            <input id="np_base_price" type="text" class="form-control" placeholder="ej: 1234,56">
          </div>
          <div class="col-md-2">
            <label class="form-label">T√©cnica</label>
            <select id="np_tech" class="form-select">
              <option value="SUB">Sublimaci√≥n</option>
              <option value="LAS">Grabado l√°ser</option>
              <option value="3D">Impresi√≥n 3D</option>
              <option value="OTR" selected>Otro</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <div class="form-check">
              <input id="np_active" type="checkbox" class="form-check-input" checked>
              <label class="form-check-label" for="np_active">Activo</label>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Descripci√≥n</label>
            <textarea id="np_description" rows="2" class="form-control" placeholder="Opcional"></textarea>
          </div>

          <hr class="mt-2">

          <div class="col-12">
            <div class="form-text mb-2">Variante opcional (pod√©s dejarlo vac√≠o y crearla despu√©s)</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Color</label>
            <input id="nv_color" type="text" class="form-control" placeholder="ej: Rojo">
          </div>
          <div class="col-md-3">
            <label class="form-label">Talle/Medida</label>
            <input id="nv_size" type="text" class="form-control" placeholder="ej: 400cc">
          </div>
          <div class="col-md-3">
            <label class="form-label">SKU variante</label>
            <input id="nv_sku" type="text" class="form-control" placeholder="Opcional">
          </div>
          <div class="col-md-3">
            <label class="form-label">Stock inicial</label>
            <input id="nv_stock" type="number" class="form-control" min="0" value="0">
          </div>

          <div class="col-12 d-flex justify-content-end gap-2">
            <button id="btnCreateProduct" type="button" class="btn btn-primary">Crear producto</button>
          </div>
          <div id="np_msg" class="form-text text-success"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Buscador con typeahead -->
  <div class="card mb-3">
    <div class="card-header">Buscar producto</div>
    <div class="card-body">

      <div class="position-relative">
        <div class="input-group">
          <input id="q" type="text" class="form-control" autocomplete="off"
                 placeholder="Escrib√≠ el SKU o nombre... (‚Üë/‚Üì y Enter para elegir)">
          <button id="btnSearch" class="btn btn-outline-secondary" type="button">Buscar</button>
        </div>

        <!-- Dropdown de sugerencias -->
        <div id="typeahead"
             class="dropdown-menu w-100 p-0"
             style="display:none; max-height:320px; overflow:auto;">
          <!-- items por JS -->
        </div>
      </div>

    </div>
  </div>

  <!-- Selecci√≥n de producto y variantes -->
  <div id="productBox" class="card d-none">
    <div class="card-header">Producto seleccionado</div>
    <div class="card-body">
      <div class="d-flex align-items-center gap-3 mb-3">
        <img id="pThumb" src="" class="rounded" style="width:64px;height:64px;object-fit:cover;" alt="">
        <div>
          <div id="pTitle" class="fw-semibold"></div>
          <div id="pSku" class="text-muted small"></div>
        </div>
      </div>

      <div class="row g-3 mb-2">
        <div class="col-12">
          <label class="form-label">Variante</label>
          <div id="variants" class="d-flex flex-wrap gap-2"></div>
          <div id="stockNow" class="form-text"></div>
        </div>
      </div>

      <div id="qtyBox" class="row g-3 d-none">
        <div class="col-md-3">
          <label class="form-label">Cantidad a ingresar</label>
          <input id="qty" type="number" class="form-control" step="1" value="1" min="1">
        </div>
        <div class="col-md-3">
          <label class="form-label">Precio de compra (bit√°cora)</label>
          <input id="unit_cost" type="text" class="form-control" placeholder="ej: 5.00">
          <div class="form-text">No modifica el precio de venta</div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Notas</label>
          <input id="note" type="text" class="form-control" placeholder="Proveedor, remito, comentarios...">
        </div>
      </div>

      <div class="d-flex justify-content-end gap-2 mt-3">
        <button id="saveBtn" class="btn btn-primary" type="button">Guardar ingreso</button>
        <a class="btn btn-outline-secondary" href="{% url 'owner_dashboard' %}">Volver</a>
      </div>
      <div id="msg" class="form-text mt-2"></div>
    </div>
  </div>

</div>

<form style="display:none">{% csrf_token %}</form>

<script>
  // === CSRF ===
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // === DOM refs ===
  const q = document.getElementById('q');
  const btnSearch = document.getElementById('btnSearch');
  const typeaheadEl = document.getElementById('typeahead');

  const productBox = document.getElementById('productBox');
  const pTitle = document.getElementById('pTitle');
  const pSku = document.getElementById('pSku');
  const pThumb = document.getElementById('pThumb');
  const variantsDiv = document.getElementById('variants');
  const stockNow = document.getElementById('stockNow');
  const qtyBox = document.getElementById('qtyBox');
  const qtyInput = document.getElementById('qty');
  const unitCost = document.getElementById('unit_cost');
  const note = document.getElementById('note');
  const saveBtn = document.getElementById('saveBtn');
  const msg = document.getElementById('msg');

  // Alta r√°pida
  const npMsg = document.getElementById('np_msg');
  const npSku = document.getElementById('np_sku');
  const npPublicName = document.getElementById('np_public_name');
  const npBasePrice = document.getElementById('np_base_price');
  const npDesc = document.getElementById('np_description');
  const npActive = document.getElementById('np_active');
  const npTech = document.getElementById('np_tech');

  const nvColor = document.getElementById('nv_color');
  const nvSize = document.getElementById('nv_size');
  const nvSku = document.getElementById('nv_sku');
  const nvStock = document.getElementById('nv_stock');
  const btnCreateProduct = document.getElementById('btnCreateProduct');

  let currentProduct = null;
  let currentVariantId = null;

  // === API helpers ===
  async function searchProducts(term) {
    const r = await fetch(`/owner/api/search_products/?q=${encodeURIComponent(term)}`);
    if (!r.ok) throw new Error('Error de b√∫squeda');
    return r.json();
  }
  async function getVariants(pid) {
    const r = await fetch(`/owner/api/product/${pid}/variants/`);
    if (!r.ok) throw new Error('Error listando variantes');
    return r.json();
  }
  async function postIntake(payload) {
    const r = await fetch(`/owner/api/stock_intake/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function createProduct(payload) {
    const r = await fetch(`/owner/api/product_create/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  // === TYPEAHEAD ===
  let taIndex = -1; // √≠ndice seleccionado
  function hideTypeahead() {
    typeaheadEl.style.display = 'none';
    typeaheadEl.innerHTML = '';
    taIndex = -1;
  }
  function showTypeahead(items) {
    typeaheadEl.innerHTML = '';
    if (!items.length) {
      const div = document.createElement('div');
      div.className = 'dropdown-item text-muted';
      div.textContent = 'Sin resultados';
      typeaheadEl.appendChild(div);
    } else {
      items.forEach((p, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dropdown-item d-flex align-items-center gap-2';
        btn.innerHTML = `
          <img src="${p.thumb}" class="rounded" style="width:36px;height:36px;object-fit:cover;"
               onerror="this.src='https://via.placeholder.com/36?text=%E2%80%94'">
          <div class="text-start">
            <div><strong>${p.sku || '(sin SKU)'}</strong> <span class="badge text-bg-light ms-1">$ ${p.base_price}</span></div>
            <div class="text-muted small">${p.public_name || ''}</div>
          </div>`;
        btn.addEventListener('click', () => { selectProduct(p); hideTypeahead(); });
        typeaheadEl.appendChild(btn);
      });
    }
    typeaheadEl.style.display = 'block';
    taIndex = -1;
  }
  function moveSelection(delta) {
    const items = Array.from(typeaheadEl.querySelectorAll('.dropdown-item'));
    if (!items.length) return;
    taIndex = Math.max(0, Math.min(items.length - 1, taIndex + delta));
    items.forEach((el, i) => el.classList.toggle('active', i === taIndex));
    // scroll al item activo
    const active = items[taIndex];
    if (active) {
      const rect = active.getBoundingClientRect();
      const parentRect = typeaheadEl.getBoundingClientRect();
      if (rect.bottom > parentRect.bottom) active.scrollIntoView(false);
      if (rect.top < parentRect.top) active.scrollIntoView();
    }
  }
  function pickSelection() {
    const items = Array.from(typeaheadEl.querySelectorAll('.dropdown-item'));
    if (taIndex >= 0 && taIndex < items.length) {
      items[taIndex].click();
    }
  }

  // Eventos b√∫squeda
  let timer = null;
  q.addEventListener('input', () => {
    const term = q.value.trim();
    if (timer) clearTimeout(timer);
    if (!term) { hideTypeahead(); return; }
    timer = setTimeout(async () => {
      try {
        const data = await searchProducts(term);
        showTypeahead(data.results || []);
      } catch(e) {
        typeaheadEl.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>';
        typeaheadEl.style.display = 'block';
      }
    }, 200);
  });
  q.addEventListener('keydown', (e) => {
    if (typeaheadEl.style.display !== 'block') return;
    if (e.key === 'ArrowDown') { e.preventDefault(); moveSelection(1); }
    else if (e.key === 'ArrowUp') { e.preventDefault(); moveSelection(-1); }
    else if (e.key === 'Enter') { e.preventDefault(); pickSelection(); }
    else if (e.key === 'Escape') { hideTypeahead(); }
  });
  q.addEventListener('blur', () => {
    // peque√±o delay para permitir click en opci√≥n
    setTimeout(hideTypeahead, 150);
  });
  btnSearch.addEventListener('click', async () => {
    const term = q.value.trim();
    if (!term) return;
    try { const data = await searchProducts(term); showTypeahead(data.results || []); }
    catch { typeaheadEl.innerHTML = '<div class="dropdown-item text-danger">Error buscando</div>'; typeaheadEl.style.display = 'block'; }
  });

  // === Selecci√≥n de producto / variantes ===
  async function selectProduct(p){
    currentProduct = p;
    currentVariantId = null;
    productBox.classList.remove('d-none');
    pTitle.textContent = p.public_name || p.sku || '(sin nombre)';
    pSku.textContent = p.sku || '(sin SKU)';
    pThumb.src = p.thumb || 'https://via.placeholder.com/64?text=%E2%80%94';
    variantsDiv.innerHTML = '';
    stockNow.textContent = '';
    qtyBox.classList.add('d-none');
    msg.textContent = '';

    const data = await getVariants(p.id);
    (data.variants || []).forEach(v => {
      const pill = document.createElement('button');
      pill.type = 'button';
      pill.className = 'btn btn-sm btn-outline-secondary';
      pill.textContent = `${v.label} ‚Äî stock: ${v.stock}`;
      pill.onclick = () => {
        [...variantsDiv.children].forEach(c => c.classList.remove('active'));
        pill.classList.add('active');
        currentVariantId = v.id;
        stockNow.textContent = `Stock actual de "${v.label}": ${v.stock}`;
        qtyBox.classList.remove('d-none');
      };
      variantsDiv.appendChild(pill);
    });
  }

  // === Guardar ingreso ===
  saveBtn.addEventListener('click', async () => {
    msg.textContent = '';
    msg.className = 'form-text';
    if (!currentProduct) { msg.textContent = 'Eleg√≠ un producto.'; return; }
    if (currentVariantId === undefined || currentVariantId === null) { msg.textContent = 'Eleg√≠ una variante.'; return; }
    const qty = parseInt(qtyInput.value || '0', 10);
    if (!qty || isNaN(qty)) { msg.textContent = 'Cantidad inv√°lida.'; return; }
    const payload = {
      product_id: currentProduct.id,
      variant_id: currentVariantId,
      qty: qty,
      unit_cost: unitCost.value || '0',
      note: note.value || ''
    };
    try {
      const out = await postIntake(payload);
      msg.className = 'form-text text-success';
      msg.textContent = `Ingreso guardado. Nuevo stock: ${out.new_stock}.`;
      qtyInput.value = '1'; unitCost.value = ''; note.value = '';
      // refrescar variantes
      const data = await getVariants(currentProduct.id);
      variantsDiv.innerHTML = '';
      (data.variants || []).forEach(v => {
        const pill = document.createElement('button');
        pill.type = 'button';
        pill.className = 'btn btn-sm btn-outline-secondary';
        pill.textContent = `${v.label} ‚Äî stock: ${v.stock}`;
        pill.onclick = () => {
          [...variantsDiv.children].forEach(c => c.classList.remove('active'));
          pill.classList.add('active');
          currentVariantId = v.id;
          stockNow.textContent = `Stock actual de "${v.label}": ${v.stock}`;
          qtyBox.classList.remove('d-none');
        };
        variantsDiv.appendChild(pill);
      });
    } catch (e) {
      msg.className = 'form-text text-danger';
      msg.textContent = 'Error: ' + ('' + e.message).slice(0, 200);
    }
  });

  // === Crear producto (alta r√°pida) ===
  btnCreateProduct.addEventListener('click', async () => {
    npMsg.textContent = '';
    npMsg.className = 'form-text';
    const payload = {
      sku: npSku.value.trim(),
      public_name: npPublicName.value.trim(),
      base_price: npBasePrice.value.trim(),
      description: npDesc.value.trim(),
      active: npActive.checked,
      tech: npTech.value, // << guarda t√©cnica
      variant: {
        color: nvColor.value.trim(),
        size: nvSize.value.trim(),
        sku: nvSku.value.trim(),
        stock: parseInt(nvStock.value || '0', 10)
      }
    };
    try {
      const out = await createProduct(payload);
      npMsg.className = 'form-text text-success';
      npMsg.textContent = 'Producto creado correctamente.';
      // seleccionar el reci√©n creado
      selectProduct(out.product);
      // limpiar form
      npSku.value=''; npPublicName.value=''; npBasePrice.value=''; npDesc.value=''; npActive.checked=true; npTech.value='OTR';
      nvColor.value=''; nvSize.value=''; nvSku.value=''; nvStock.value='0';
    } catch (e) {
      npMsg.className = 'form-text text-danger';
      npMsg.textContent = ('' + e.message).slice(0, 200);
    }
  });
</script>
{% endblock %}
