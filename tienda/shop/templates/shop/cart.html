{% extends "base.html" %}
{% load humanize %}

{% block title %}Carrito{% endblock %}

{% block content %}
<div class="container py-3">
  <h1 class="h5 mb-3">Carrito</h1>

  {% if coupon_msg %}
    <div class="alert alert-info py-2">{{ coupon_msg }}</div>
  {% endif %}

  {% if items %}
    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <div class="table-responsive">
          <table class="table align-middle">
            <thead>
              <tr>
                <th style="width:72px;"></th>
                <th>Producto</th>
                <th class="text-end">Unitario</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">Subtotal</th>
                <th class="text-end"></th>
              </tr>
            </thead>
            <tbody>
              {% for it in items %}
              <tr>
                <td>
                  {% if it.thumb %}
                    <img src="{{ it.thumb }}" alt="" class="rounded" style="width:64px;height:64px;object-fit:cover;">
                  {% else %}
                    <img src="https://via.placeholder.com/64?text=%E2%80%94" alt="" class="rounded" style="width:64px;height:64px;object-fit:cover;">
                  {% endif %}
                </td>

                <td>
                  <div class="fw-semibold">{{ it.product.public_name|default:it.product.sku }}</div>
                  <div class="text-muted small">
                    Variante: {{ it.variant_label|default:"Única" }}
                  </div>
                </td>

                <td class="text-end">
                  {% if it.unit_price_now %}
                    {% if it.unit_price_now != it.unit_price %}
                      <div class="small text-muted"><s>$ {{ it.unit_price|floatformat:2 }}</s></div>
                      <div class="fw-semibold text-danger">$ {{ it.unit_price_now|floatformat:2 }}</div>
                    {% else %}
                      <div class="fw-semibold">$ {{ it.unit_price_now|floatformat:2 }}</div>
                    {% endif %}
                  {% else %}
                    <div class="fw-semibold">$ {{ it.unit_price|floatformat:2 }}</div>
                  {% endif %}
                </td>

                <td class="text-center">
                  <div class="d-flex align-items-center justify-content-center gap-2 flex-wrap">

                    <!-- Restar 1 -->
                    <form method="post" action="{% url 'cart_update' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="variant_id" value="{{ it.variant.id }}">
                      <input type="hidden" name="op" value="sub">
                      <input type="hidden" name="qty" value="1">
                      <button class="btn btn-sm btn-outline-secondary" title="Restar 1" {% if it.qty <= 1 %}disabled{% endif %}>−</button>
                    </form>

                    <!-- Setear cantidad exacta -->
                    <form method="post" action="{% url 'cart_update' %}" class="d-inline d-flex align-items-center gap-2">
                      {% csrf_token %}
                      <input type="hidden" name="variant_id" value="{{ it.variant.id }}">
                      <input type="hidden" name="op" value="set">
                      <input type="number" class="form-control form-control-sm text-center" name="qty" value="{{ it.qty }}" min="0" style="width:90px">
                      <button class="btn btn-sm btn-primary">Actualizar</button>
                    </form>

                    <!-- Sumar 1 -->
                    <form method="post" action="{% url 'cart_update' %}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="variant_id" value="{{ it.variant.id }}">
                      <input type="hidden" name="op" value="add">
                      <input type="hidden" name="qty" value="1">
                      <button class="btn btn-sm btn-outline-secondary" title="Sumar 1">+</button>
                    </form>

                    <!-- Restar N (por defecto 5) -->
                    <form method="post" action="{% url 'cart_update' %}" class="d-inline d-flex align-items-center gap-2">
                      {% csrf_token %}
                      <input type="hidden" name="variant_id" value="{{ it.variant.id }}">
                      <input type="hidden" name="op" value="sub">
                      <input type="number" class="form-control form-control-sm text-center" name="qty" value="5" min="1" style="width:90px">
                      <button class="btn btn-sm btn-outline-danger">Restar N</button>
                    </form>

                  </div>
                </td>

                <td class="text-end">
                  {% if it.line_total_now %}
                    {% if it.line_total_now != it.line_total %}
                      <div class="small text-muted"><s>$ {{ it.line_total|floatformat:2 }}</s></div>
                      <div class="fw-semibold text-danger">$ {{ it.line_total_now|floatformat:2 }}</div>
                    {% else %}
                      <div class="fw-semibold">$ {{ it.line_total_now|floatformat:2 }}</div>
                    {% endif %}
                  {% else %}
                    <div class="fw-semibold">$ {{ it.line_total|floatformat:2 }}</div>
                  {% endif %}
                </td>

                <td class="text-end">
                  <!-- Eliminar → set qty 0 -->
                  <form method="post" action="{% url 'cart_update' %}" onsubmit="return confirm('¿Quitar este producto del carrito?')">
                    {% csrf_token %}
                    <input type="hidden" name="variant_id" value="{{ it.variant.id }}">
                    <input type="hidden" name="op" value="set">
                    <input type="hidden" name="qty" value="0">
                    <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>

            <tfoot>
              <tr>
                <th colspan="4" class="text-end">Subtotal</th>
                <th class="text-end">$ {{ subtotal|floatformat:2 }}</th>
                <th></th>
              </tr>
              {% if applied_coupon %}
              <tr>
                <th colspan="4" class="text-end">Cupón ({{ applied_coupon.code }})</th>
                <th class="text-end">-{{ applied_coupon.percent }}%</th>
                <th></th>
              </tr>
              {% endif %}
              <tr>
                <th colspan="4" class="text-end fs-5">Total</th>
                <th class="text-end fs-5">$ {{ total|floatformat:2 }}</th>
                <th></th>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-3">Cupón de descuento</h2>

            {% if applied_coupon %}
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove_coupon">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div><span class="badge text-bg-success">{{ applied_coupon.code }}</span> aplicado</div>
                  <button class="btn btn-sm btn-outline-danger">Quitar</button>
                </div>
              </form>
            {% else %}
              <form method="post" class="input-group">
                {% csrf_token %}
                <input type="hidden" name="action" value="apply_coupon">
                <input type="text" name="coupon" class="form-control" placeholder="Código de cupón">
                <button class="btn btn-outline-primary">Aplicar</button>
              </form>
            {% endif %}

            <hr class="my-3">

            <a href="{% url 'checkout' %}" class="btn btn-primary w-100">
              Ir a pagar
            </a>
          </div>
        </div>
      </div>
    </div>

  {% else %}
    <div class="text-center text-muted py-5">
      Tu carrito está vacío.
      <div class="mt-3">
        <a class="btn btn-primary" href="{% url 'catalog' %}">Ir al catálogo</a>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
