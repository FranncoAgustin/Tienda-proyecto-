{% extends "base.html" %}
{% load humanize %}

{% block title %}Catálogo{% endblock %}

{% block content %}
<div class="container py-3">

  <!-- Encabezado -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h5 mb-0">Catálogo</h1>
  </div>

  <!-- Búsqueda -->
  <form class="mb-3" method="get">
    <div class="input-group">
      <input type="text" class="form-control" name="q" value="{{ q }}"
        placeholder="Buscar por nombre, descripción o SKU">
      {% if t %}<input type="hidden" name="t" value="{{ t }}">{% endif %}
      <button class="btn btn-primary" type="submit">Buscar</button>
      {% if q or t %}
      <a class="btn btn-outline-secondary" href="{% url 'catalog' %}">Limpiar</a>
      {% endif %}
    </div>
  </form>

  <!-- Filtros por técnica -->
  {% with tl=t|default:''|lower %}
  <div class="d-flex flex-wrap gap-2 mb-3">
    <a class="btn btn-sm {% if not tl %}btn-primary{% else %}btn-outline-primary{% endif %}"
      href="?{% if q %}q={{ q|urlencode }}&{% endif %}">Todo</a>

    <a class="btn btn-sm {% if tl == 'sub' %}btn-primary{% else %}btn-outline-primary{% endif %}"
      href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=sub">Sublimación</a>

    <a class="btn btn-sm {% if tl == 'laser' %}btn-primary{% else %}btn-outline-primary{% endif %}"
      href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=laser">Grabado láser</a>

    <a class="btn btn-sm {% if tl == '3d' %}btn-primary{% else %}btn-outline-primary{% endif %}"
      href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=3d">Impresión 3D</a>

    <a class="btn btn-sm {% if tl == 'otr' %}btn-primary{% else %}btn-outline-primary{% endif %}"
      href="?{% if q %}q={{ q|urlencode }}&{% endif %}t=otr">Otro</a>
  </div>
  {% endwith %}

  <!-- Grilla de productos -->
  <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3">
    {% for p in products %}
    <div class="col">
      <div class="card h-100 shadow-sm">

        <!-- Imagen + badges -->
        <div class="position-relative">
          <a href="{% url 'product_detail' sku=p.sku %}" class="d-block">
            <div class="ratio ratio-4x3">
              {% with img=p.images.first %}
              {% if img %}
              <img src="{{ img.image.url }}" class="w-100 h-100" style="object-fit: cover;"
                alt="{{ p.public_name|default:p.sku }}" loading="lazy">
              {% else %}
              <img src="https://via.placeholder.com/800x600?text=Sin+imagen" class="w-100 h-100"
                style="object-fit: cover;" alt="{{ p.public_name|default:p.sku }}" loading="lazy">
              {% endif %}
              {% endwith %}
            </div>
          </a>

          {% if p.view_discount_percent %}
          <span class="badge text-bg-danger position-absolute top-0 start-0 m-2">
            {{ p.view_discount_percent }}% OFF
          </span>
          {% endif %}

          {% if p.tech %}
          <span class="badge text-bg-light position-absolute top-0 end-0 m-2">
            {{ p.get_tech_display }}
          </span>
          {% endif %}
        </div>

        <!-- Cuerpo -->
        <div class="card-body d-flex flex-column">
          <a href="{% url 'product_detail' sku=p.sku %}" class="text-decoration-none text-reset">
            <h2 class="h6 mb-2 text-truncate" title="{{ p.public_name|default:p.sku }}">
              {{ p.public_name|default:p.sku }}
            </h2>
          </a>

          <!-- Precio -->
          <div class="mt-auto">
            {% if p.view_discounted_price %}
            <div class="small text-muted mb-1">
              <s>$ {{ p.base_price|floatformat:2 }}</s>
            </div>
            <div class="fw-semibold fs-5 text-danger">
              $ {{ p.view_discounted_price|floatformat:2 }}
            </div>
            {% if p.view_promo_ends %}
            <div class="small text-muted">hasta {{ p.view_promo_ends|date:"d/m H:i" }}</div>
            {% endif %}
            {% else %}
            <div class="fw-semibold fs-5">
              $ {{ p.base_price|floatformat:2 }}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Footer -->
        <div class="card-footer bg-transparent border-0 pt-0 d-grid gap-2">
          <a class="btn btn-sm btn-outline-primary w-100" href="{% url 'product_detail' sku=p.sku %}">
            Ver detalle
          </a>
          <button type="button" class="btn btn-sm btn-primary w-100 btn-quick-add"
            data-variants-url="{% url 'product_variants_json' sku=p.sku %}">
            Agregar al carrito
          </button>
        </div>

      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <div class="text-center text-muted py-5">
        No encontramos productos con ese filtro.
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Paginación -->
  {% if page_obj.paginator.num_pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t|urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}">«</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">«</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
      {% if num == page_obj.number %}
      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
      {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item">
        <a class="page-link"
          href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t|urlencode }}&{% endif %}page={{ num }}">{{
          num }}</a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link"
            href="?{% if q %}q={{ q|urlencode }}&{% endif %}{% if t %}t={{ t|urlencode }}&{% endif %}page={{ page_obj.next_page_number }}">»</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
    </ul>
  </nav>
  {% endif %}

</div>

<!-- JS: Quick Add con restauración del botón -->
<script>
  (function () {
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    async function quickAdd(btn) {
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'Agregando…';

      const restore = () => { btn.textContent = originalText; btn.disabled = false; };

      try {
        // 1) Traer variantes del producto
        const url = btn.dataset.variantsUrl;
        const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if (!r.ok) throw new Error('No se pudo cargar variantes');
        const data = await r.json();
        const variants = data.variants || [];
        const choice = variants.find(v => Number(v.stock || 0) > 0) || variants[0];

        if (!choice) { alert('No hay variantes para este producto.'); restore(); return; }
        if (Number(choice.stock || 0) <= 0) { alert('Sin stock disponible.'); restore(); return; }

        // 2) Agregar 1 unidad al carrito
        const add = await fetch("{% url 'cart_add' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
            'Accept': 'application/json'
          },
          credentials: 'same-origin',   // ← importante para que viaje la cookie de sesión
          body: JSON.stringify({ variant_id: choice.id, qty: 1 })
        });
        if (!add.ok) {
          const msg = await add.text();
          throw new Error(msg.slice(0, 200));
        }

        // 3) Feedback + actualizar badge si existe
        let cartQty = null;
        try { const j = await add.json(); cartQty = j.cart_qty; } catch (e) { }

        btn.textContent = 'Agregado ✓';
        setTimeout(() => { restore(); }, 900);

        const badge = document.querySelector('[data-cart-badge]');
        if (badge && cartQty != null) badge.textContent = cartQty;

      } catch (e) {
        console.error(e);
        alert('No se pudo agregar este producto. ' + (e.message || ''));
        restore();
      }
    }

    document.addEventListener('click', function (ev) {
      const btn = ev.target.closest('.btn-quick-add');
      if (btn) { quickAdd(btn); }
    });
  })();
</script>
{% endblock %}