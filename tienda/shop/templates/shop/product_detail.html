{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ product.public_name|default:product.sku }}{% endblock %}

{% block content %}
<div class="container py-3">
  <div class="row g-4">
    <!-- Galería -->
    <div class="col-12 col-md-6">
      <div class="card shadow-sm">
        <div class="ratio ratio-4x3">
          {% with first=product.images.first %}
            {% if first %}
              <img id="pd-main-img" src="{{ first.image.url }}" class="w-100 h-100" style="object-fit:cover;" alt="{{ product.public_name|default:product.sku }}">
            {% else %}
              <img id="pd-main-img" src="https://via.placeholder.com/800x600?text=Sin+imagen" class="w-100 h-100" style="object-fit:cover;" alt="{{ product.public_name|default:product.sku }}">
            {% endif %}
          {% endwith %}
        </div>
      </div>

      {% if product.images.all %}
      <div class="d-flex flex-wrap gap-2 mt-2">
        {% for im in product.images.all %}
          <img src="{{ im.image.url }}" data-full="{{ im.image.url }}"
               class="rounded shadow-sm" style="width:72px;height:72px;object-fit:cover;cursor:pointer"
               alt="thumb {{ forloop.counter }}">
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- Info + Agregar al carrito -->
    <div class="col-12 col-md-6">
      <h1 class="h4 mb-1">{{ product.public_name|default:product.sku }}</h1>

      <div class="d-flex align-items-center gap-2 mb-2">
        {% if product.tech %}
          <span class="badge text-bg-light">{{ product.get_tech_display }}</span>
        {% endif %}
        {% if product.sku %}
          <span class="text-muted small">SKU: {{ product.sku }}</span>
        {% endif %}
      </div>

      <div class="mb-3">
        {% if product.discounted_price %}
          <div class="small text-muted mb-1"><s>$ {{ product.base_price|floatformat:2 }}</s></div>
          <div class="fs-3 fw-semibold text-danger">$ {{ product.discounted_price|floatformat:2 }}</div>
          {% if product.discount_percent %}<div class="small text-danger fw-semibold">{{ product.discount_percent|floatformat:0 }}% OFF</div>{% endif %}
          {% if product.promo_ends %}<div class="small text-muted">hasta {{ product.promo_ends|date:"d/m H:i" }}</div>{% endif %}
        {% else %}
          <div class="fs-3 fw-semibold">$ {{ product.base_price|floatformat:2 }}</div>
        {% endif %}
      </div>

      {% include "shop/cart_add.html" with product=product %}
    </div>
  </div>
</div>

<script>
(function(){
  // Thumbnails -> imagen principal
  document.addEventListener('click', function(ev){
    const t = ev.target.closest('[data-full]');
    if (!t) return;
    const main = document.getElementById('pd-main-img');
    if (main) main.src = t.dataset.full;
  });

  // Cambiar imagen si la variante tiene imagen propia
  document.addEventListener('cart:variant-changed', function(e){
    const url = e.detail && e.detail.image_url;
    if (!url) return;
    const main = document.getElementById('pd-main-img');
    if (main) main.src = url;
  });

  // Envío por fetch ya lo manejás en el cart_add.html
})();
</script>
{% endblock %}
